{% extends "base.html" %} {% block content %}
<div class="layui-card">
  <div class="layui-card-header">控制台</div>
  <div class="layui-card-body" pad15="">
    <div class="button-container">
      <button class="layui-btn" id="start-camera-btn">摄像头调用</button>
      <button class="layui-btn" id="start-video-btn">视频调用</button>
      <input
        type="text"
        id="video-path"
        placeholder="Enter video path"
        class="layui-input"
        value="test.mp4"
        style="flex-grow: 1"
      />
      <button
        class="layui-btn layui-btn-danger"
        id="stop-btn"
        style="display: none"
      >
        停止
      </button>
    </div>
    <div id="status"></div>
    <div id="framerate">FPS: <span id="fps-value">0</span></div>
    <div class="canvas-container">
      <canvas id="video-canvas" width="640" height="480"></canvas>
    </div>
  </div>
</div>
{% endblock %} {% block js %}
<script>
  $(document).ready(function () {
    let logId = null;
    let websocket = null;
    let frameCount = 0;
    let lastTime = performance.now();  // 使用 performance.now() 提高时间精度
    const canvas = document.getElementById("video-canvas");
    const context = canvas.getContext("2d");
    const img = new Image();  // 预定义图像对象

    function drawImage(base64Image) {
      img.src = "data:image/jpeg;base64," + base64Image;  // 设定图像来源
    }

    img.onload = function () {
      requestAnimationFrame(() => {  // 使用 requestAnimationFrame 保证流畅渲染
        context.clearRect(0, 0, canvas.width, canvas.height); // 清空画布
        context.drawImage(img, 0, 0, canvas.width, canvas.height);  // 绘制图像
        updateFrameRate();  // 更新帧率
      });
    };

    function updateFrameRate() {
      frameCount++;
      const now = performance.now();
      const deltaTime = (now - lastTime) / 1000; // 以秒为单位计算时间差
      if (deltaTime >= 1) {  // 每秒更新一次帧率
        const fps = frameCount / deltaTime;
        $("#fps-value").text(fps.toFixed(2));  // 显示FPS
        frameCount = 0;
        lastTime = now;
      }
    }

    // 开始摄像头调用
    $("#start-camera-btn").click(function () {
      $.post("/start_processing", { input_type: "camera" }, function (data) {
        $("#status").text("Processing started with log ID: " + data.log_id);
        logId = data.log_id;
        $("#stop-btn").show();
        $("#start-camera-btn").hide();
        $("#start-video-btn").hide();
        startWebSocket();  // 启动 WebSocket 连接
      }).fail(function () {
        layer.msg("Error starting processing.");
        $("#status").text("Error starting processing.");
      });
    });

    // 开始视频调用
    $("#start-video-btn").click(function () {
      const videoPath = $("#video-path").val();
      $.post(
        "/start_processing",
        { input_type: "video", video_path: videoPath },
        function (data) {
          $("#status").text("Processing started with log ID: " + data.log_id);
          logId = data.log_id;
          $("#stop-btn").show();
          $("#start-camera-btn").hide();
          $("#start-video-btn").hide();
          startWebSocket();  // 启动 WebSocket 连接
        }
      ).fail(function () {
        $("#status").text("Error starting processing.");
      });
    });

    // 停止处理
    $("#stop-btn").click(function () {
      stopProcessing();
    });

    function stopProcessing() {
      $.post("/stop_processing", function () {
        $("#status").text("Processing stopped.");
        $("#stop-btn").hide();
        $("#start-camera-btn").show();
        $("#start-video-btn").show();
        if (websocket) {
          websocket.close();  // 关闭 WebSocket 连接
        }
      }).fail(function () {
        $("#status").text("Error stopping processing.");
      });
    }

    // 启动 WebSocket
    function startWebSocket() {
      websocket = new WebSocket("ws://" + window.location.host + "/ws/stream");
      websocket.onmessage = function (event) {
        drawImage(event.data);  // 处理传入的帧
      };

      websocket.onerror = function () {
        $("#status").text("WebSocket connection error.");
        websocket.close();
      };

      websocket.onclose = function () {
        $("#status").text("WebSocket connection closed.");
      };
    }
  });
</script>
{% endblock %}

